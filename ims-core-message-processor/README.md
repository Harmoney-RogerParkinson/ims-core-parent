#ims-core-message-processor

The role of the Message Processor is to receive messages from the [bayeux](https://en.wikipedia.org/wiki/Comet_(programming)) queue generated by Salesforce triggers which fire when new records/objects are created in the Salesforce database.

Messages describe the new record and the Message Processor gives them an initial check before saving them into a local database. The local database is actually a postgres database normally hosted on AWS. It *might* be a MoM. The format of the queue entries is some key information plus a blob containing the raw message. Incoming messages may contain multiple sub messages (ie refer to multiple record updates) and the message processor will break thes up into multiple internal queue entries. It will not do much else.

There are restart scenarios: the server might restart, the client (ie the Message Processor) might restart. Both need to be handled cleanly. Messages are numbered but not necessarily contiguously. The Message Processor will at least need to remember the last processed message and request new messages from that plus one. That's a db save because if it crashes it won't have memory.

The Message Processor does not process the messages directly. It will probably split them up into several sub-messages (yet to nail down the message format but this seems likely) and save them into an internal queue which is a rabbitMQ topic named *transaction-queue* (configurable)

##SalesForce Tables
<img src="AndrewTables.jpg" width="1000">

<img src="SalesForceTables.png" width="1000">

The Investor Fund Transaction is like the Account Summary and Investment Order, they all extend a 'virtul' parent, which means they *ought* to extend one but it doesn't exist. The goal is to get these to a flat single table which eliminates duplicate fields but contains potentially empty fields when those fields belong to a different 'type'.

## Connecting to Salesforce
The topics (not the SOAP API) need to know your IP address for security reasons. Use Quick Find to search for Network and open up 'Network Access'
Make sure your current IP is in one of those ranges.
To find your current ip address Google: my ip address

## Creating a Topic

```
trigger insertInvestorLoanTransaction on InvestorLoanTransaction(after insert) {
		PushTopic pushTopic = new PushTopic();
		pushTopic.Name = 'InvestorLoanTransactionInserts';
		pushTopic.Query = 'SELECT Id, 
			Name, 
			Status__c, 
			Description__c 
			FROM loan__Investor_Loan_Account_Txns__c	';
		pushTopic.ApiVersion = 38.0;
		pushTopic.NotifyForOperationCreate = true;
		pushTopic.NotifyForOperationUpdate = true;
		pushTopic.NotifyForOperationUndelete = true;
		pushTopic.NotifyForOperationDelete = true;
		pushTopic.NotifyForFields = 'Referenced';
		insert pushTopic;
	}
}
```








