#ims-core-message-processor

The role of the Message Processor is to receive messages from the [bayeux](https://en.wikipedia.org/wiki/Comet_(programming)) queue generated by Salesforce triggers which fire when new records/objects are created in the Salesforce database.

Messages describe the new record and the Message Processor gives them an initial check before saving them into a local database. The local database is actually a postgres database normally hosted on AWS. It *might* be a MoM. The format of the queue entries is some key information plus a blob containing the raw message. Incoming messages may contain multiple sub messages (ie refer to multiple record updates) and the message processor will break thes up into multiple internal queue entries. It will not do much else.

There are restart scenarios: the server might restart, the client (ie the Message Processor) might restart. Both need to be handled cleanly. Messages are numbered but not necessarily contiguously. The Message Processor will at least need to remember the last processed message and request new messages from that plus one. That's a db save because if it crashes it won't have memory.

The Message Processor does not process the messages directly. It will probably split them up into several sub-messages (yet to nail down the message format but this seems likely) and save them into an internal queue which is a rabbitMQ topic named *transaction-queue* (configurable)

##SalesForce Tables
<img src="AndrewTables.jpg" width="1000">

<img src="SalesForceTables.png" width="1000">

The Investor Fund Transaction is like the Account Summary and Investment Order, they all extend a 'virtual' parent, which means they *ought* to extend one but it doesn't exist. The goal is to get these to a flat single table which eliminates duplicate fields but contains potentially empty fields when those fields belong to a different 'type'.

## Connecting to Salesforce
The topics (not the SOAP API) need to know your IP address for security reasons. Use Quick Find to search for Network and open up 'Network Access'
Make sure your current IP is in one of those ranges.
To find your current ip address Google: my ip address

## Creating a Topic

https://developer.salesforce.com/docs/atlas.en-us.api_streaming.meta/api_streaming/create_a_pushtopic.htm

```
PushTopic pushTopic = new PushTopic();
pushTopic.Name = 'ILTIMS';
pushTopic.Query = 'SELECT Id,Name,CreatedDate, Loan_Payment_Transaction_Remark__c, Original_Protect_Realised__c, Loan_Payment_Transaction_Protect_Realise__c, Share_Rounded__c, LastModifiedDate, isDeleted, loan__Investor_Loan__c, loan__Principal_Paid__c,loan__Interest_Paid__c, loan__Late_Fees_Paid__c,loan__Tax__c, loan__Total_Service_Charge__c,loan__Charged_Off_Date__c,Extra_Protect_Realised__c,HP_Management_Fee__c, Protect_Fee_Amount__c,Protect_Realised_Active__c,Protect_Charge_Off__c,HP_Sale_Commission_Fee__c,Protect_Enabled__c,loan__Charged_Off_Fees__c,loan__Charged_Off_Interest__c, loan__Charged_Off_Principal__c,Investor_Txn_Fee__c, loan__Txn_Code__c,loan__Waived__c, loan__Protect_Principal__c, loan__Txn_Type__c, loan__Rebate_Amount_On_Payoff__c  FROM loan__Investor_Loan_Account_Txns__c where LastModifiedDate > 1990-10-08T01:02:03Z';pushTopic.ApiVersion = 38.0;
pushTopic.NotifyForOperationCreate = true;
pushTopic.NotifyForOperationUpdate = true;
pushTopic.NotifyForOperationUndelete = true;
pushTopic.NotifyForOperationDelete = true;
pushTopic.NotifyForFields = 'Referenced';
insert pushTopic;
```

note that it does *not* like the query split over multiple lines and it does not like
references to attached objects, eg querying the account id through the attached account record doesn't work.
For some reason it also doesn't like these fields:

 * Management_Fee_Realised__c, 
 * Sales_Commission_Fee_Realised__c,
 * Protect_Realised__c
 
These are all Formula fields, but so is loan__Protect_Principal__c and that is fine. The error suggests it is not finding the field (ie suggests adding a __c to the end etc). Also it must have the test__c field to allow the integration tests to work.
...those bad fields have formulae with IF in them. I added more fields to fetch the component fields the formula was referencing and then replicated the formulae in the Java code. Apart from a divide by zero issue (which I 'iffed' out it is working.

Format of message is (roughly):

{event={createdDate=2017-02-21T08:20:09.181Z, replayId=33, type=created}, 
sobject={Description__c=whatever, Id=a6fN00000008giLIAQ, Status__c=Open, Name=INV-0033}}

This is a HashMap whose values are HashMaps. All the keys are Strings. The values are whatever data type is suitable, often a String but could be a Date, Long etc. Currency is a String, number() is a double. What is date? Percentage?
Date is a string, percentage is double.
The event section has a type field:
created, updated
We do not hear if the record is deleted or undeleted...maybe
docs are contradictory.
If we do get a delete we should create a reversal, an undelete should create a new record.

Deleting a pushTopic:

```
List<PushTopic> pts = [SELECT Id FROM PushTopic WHERE Name = 'ILTIMS'];
Database.delete(pts);
``` 

for the rjpsandbox there is a new test object created and the pushtopic looks like this:

```
List<PushTopic> pts = [SELECT Id FROM PushTopic WHERE Name = 'ILTIMS'];
Database.delete(pts);

PushTopic pushTopic = new PushTopic();
pushTopic.Name = 'ILTIMS';
pushTopic.Query = 'SELECT Id,Name,CreatedDate, Account_ID__c, Loan_Payment_Transaction_Remark__c, Original_Protect_Realised__c, Loan_Payment_Transaction_Protect_Realise__c, Share_Rounded__c, LastModifiedDate, isDeleted, loan__Investor_Loan__c, loan__Principal_Paid__c,loan__Interest_Paid__c, loan__Late_Fees_Paid__c,loan__Tax__c, loan__Total_Service_Charge__c,loan__Charged_Off_Date__c,Extra_Protect_Realised__c,HP_Management_Fee__c, Protect_Fee_Amount__c,Protect_Realised_Active__c,Protect_Charge_Off__c,HP_Sale_Commission_Fee__c,Protect_Enabled__c,loan__Charged_Off_Fees__c,loan__Charged_Off_Interest__c, loan__Charged_Off_Principal__c,Investor_Txn_Fee__c, loan__Txn_Code__c,loan__Waived__c, loan__Protect_Principal__c, loan__Txn_Type__c, loan__Rebate_Amount_On_Payoff__c,Net_Amount__c,Rejected__c,Reversed__c,Reverse_Rejected_Date__c  FROM loan__Investor_Loan_Account_Txns__c where LastModifiedDate > 1990-10-08T01:02:03Z';
pushTopic.ApiVersion = 38.0;
pushTopic.NotifyForOperationCreate = true;
pushTopic.NotifyForOperationUpdate = true;
pushTopic.NotifyForOperationUndelete = true;
pushTopic.NotifyForOperationDelete = true;
pushTopic.NotifyForFields = 'All';
insert pushTopic;
``` 
extra fields I had to create in SF to overcome the IF in the formulae:

```
loan__Loan_Payment_Transaction__r.Remark__c Loan_Payment_Transaction_Remark__c
loan__Loan_Payment_Transaction__r.Original_Protect_Realised__c Original_Protect_Realised__c
loan__Loan_Payment_Transaction__r.Protect_Realised__c Loan_Payment_Transaction_Protect_Realised__c
loan__Investor_Loan__r.loan__Share_rounded__c Share_Rounded__c,
loan__Investor_Loan__r.loan__Loan__r.Extra_Protect_Realised__c	Extra_Protect_Realised__c,
loan__Investor_Loan__r.loan__Loan__r.HP_Management_Fee__c HP_Management_Fee__c,
loan__Investor_Loan__r.loan__Loan__r.loan__Protect_fee_amount__c Protect_Fee_Amount__c,
loan__Investor_Loan__r.loan__Loan__r.Protect_Realised_Active__c Protect_Realised_Active__c,
loan__Investor_Loan__r.loan__Loan__r.Protect_Charge_Off__c Protect_Charge_Off__c,
loan__Investor_Loan__r.loan__Loan__r.HP_Sale_Commission_Fee__c HP_Sale_Commission_Fee__c,
loan__Investor_Loan__r.loan__Loan__r.loan__Protect_Enabled__c Protect_Enabled__c,
loan__Loan_Payment_Transaction__r.loan__Rejected__c Rejected__c
loan__Loan_Payment_Transaction__r.loan__Reversed__c Reversed__c
loan__Loan_Payment_Transaction__r.Reverse_Rejected_Date__c Reverse_Rejected_Date__c

```

PushTopic for the InvestorFundTransaction

```
List<PushTopic> pts = [SELECT Id FROM PushTopic WHERE Name = 'IFTIMS'];
Database.delete(pts);

PushTopic pushTopic = new PushTopic();
pushTopic.Name = 'IFTIMS';
pushTopic.Query = 'SELECT Id,Name,CreatedDate, loan__Account__c, loan__Transaction_Date__c, loan__Transaction_Type__c, loan__transaction_amount__c, loan__Cleared__c,loan__Rejected__c, loan__Reversed__c,Reverse_Rejected_Date__c FROM loan__Investor_Fund_Transaction__c where LastModifiedDate > 1990-10-08T01:02:03Z';
pushTopic.ApiVersion = 38.0;
pushTopic.NotifyForOperationCreate = true;
pushTopic.NotifyForOperationUpdate = true;
pushTopic.NotifyForOperationUndelete = true;
pushTopic.NotifyForOperationDelete = true;
pushTopic.NotifyForFields = 'All';
insert pushTopic;
```
*The Salesforce Apex window where you enter this code only accepts one topic at a time. It looks like 'execute highlight' will work but it doesn't*


